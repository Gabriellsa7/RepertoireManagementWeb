@page "/LeaderShow/{bandId:guid}/{repertoireId:guid}"
@model LeaderShowModel
@{
    ViewData["Title"] = "Controle do Show";
}

<link rel="stylesheet" href="~/css/custom.css" asp-append-version="true" />

<h2>Band - @Model.BandName</h2>

<div>
    <hr />
    <span class="fs-3">Repertório: @Model.RepertoireName</span>
    <hr />
    <div class="d-flex flex-column gap-3 my-3">
        <span class="fw-bold fs-5">Musics</span>
        <div class="d-flex flex-row gap-3">
            @foreach (var music in Model.Musics)
            {

                <button class="btn btn-main"
                        onclick="changeSong('@music.Id')">
                    @music.Title
                </button>

            }
        </div>
    </div>
    <div class="d-flex flex-column gap-2">
        <span class="fs-4" id="leader-current-title">@Model.Musics.FirstOrDefault()?.Title</span>
        <iframe id="leader-song-pdf" src="@($"/MusicPages/PdfDownload?id={@Model.Musics.FirstOrDefault()?.Id}")"
                width="100%" height="600px" style="border:1px solid #ccc;"></iframe>
    </div>
</div>

<hr />
<a asp-page="/BandPages/Index" class="btn btn-main">Back</a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    const bandId = "@Model.BandId";

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/showHub")
        .build();

    connection.on("ReceiveSong", (title, pdfUrl) => {
        document.getElementById("leader-current-title").innerText = title ?? "";
        document.getElementById("leader-song-pdf").src = pdfUrl ?? "";
    });

    connection.start()
        .then(() => connection.invoke("JoinBand", bandId))
        .catch(err => console.error(err));

    function changeSong(musicId) {
        connection.invoke("ChangeSong", bandId, musicId)
            .catch(err => console.error(err));
    }
</script>
